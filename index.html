<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cell Segmentation & Analysis</title>
    <!-- Add marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
            min-height:100vh; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            padding:20px; 
        }
        
        .upload-container { 
            background:white; 
            border-radius:16px; 
            box-shadow:0 15px 35px rgba(0,0,0,0.1); 
            width:100%; 
            max-width:900px; 
            overflow:hidden; 
            padding:30px; 
            transition:all .3s ease; 
        }
        
        .upload-header { 
            text-align:center; 
            margin-bottom:25px; 
        }
        
        .upload-header h2 { 
            color:#333; 
            font-weight:600; 
            margin-bottom:8px; 
            font-size:24px; 
        }
        
        .upload-header p { 
            color:#666; 
            font-size:14px; 
        }
        
        .upload-area { 
            border:2px dashed #ddd; 
            border-radius:12px; 
            padding:40px 20px; 
            text-align:center; 
            transition:all .3s ease; 
            cursor:pointer; 
            position:relative; 
            margin-bottom:20px; 
            background:#f9f9f9; 
        }
        
        .upload-area:hover, .upload-area.drag-over { 
            border-color:#667eea; 
            background-color:rgba(102,126,234,0.05); 
        }
        
        .upload-icon { 
            font-size:48px; 
            color:#667eea; 
            margin-bottom:15px; 
        }
        
        .upload-text { 
            color:#666; 
            margin-bottom:10px; 
            font-size:16px; 
        }
        
        .upload-button { 
            color:#667eea; 
            font-weight:600; 
            text-decoration:underline; 
            cursor:pointer; 
        }
        
        .file-input { 
            position:absolute; 
            width:100%; 
            height:100%; 
            top:0; 
            left:0; 
            opacity:0; 
            cursor:pointer; 
        }
        
        .image-preview { 
            margin-top:20px; 
            display:none; 
        }
        
        .preview-img { 
            max-width:100%; 
            border-radius:12px; 
            box-shadow:0 5px 15px rgba(0,0,0,0.1); 
        }
        
        .preview-header { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            margin-bottom:10px; 
        }
        
        .preview-title { 
            color:#333; 
            font-size:16px; 
        }
        
        .remove-image { 
            background:none; 
            border:none; 
            color:#ff5252; 
            cursor:pointer; 
            font-size:14px; 
            font-weight:500; 
        }
        
        .upload-btn { 
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
            color:white; 
            border:none; 
            padding:12px 24px; 
            border-radius:8px; 
            font-size:16px; 
            font-weight:500; 
            cursor:pointer; 
            width:100%; 
            margin-top:20px; 
            transition:all .3s ease; 
            opacity:.7; 
            pointer-events:none; 
        }
        
        .upload-btn.active { 
            opacity:1; 
            pointer-events:auto; 
        }
        
        .upload-btn:hover.active { 
            transform:translateY(-2px); 
            box-shadow:0 7px 14px rgba(102,126,234,0.3); 
        }
        
        /* Dashboard button styling */
        .dashboard-btn { 
            background:linear-gradient(135deg,#4a6cf7 0%,#6c4af6 100%); 
            color:white; 
            border:none; 
            padding:12px 24px; 
            border-radius:8px; 
            font-size:16px; 
            font-weight:500; 
            cursor:pointer; 
            width:100%; 
            margin-bottom:15px; 
            transition:all .3s ease; 
            opacity:1; 
            pointer-events:auto; 
        }
        
        .dashboard-btn:hover { 
            transform:translateY(-2px); 
            box-shadow:0 7px 14px rgba(74, 108, 247, 0.3); 
        }
        
        .loading { 
            display:none; 
            text-align:center; 
            margin:20px 0; 
        }
        
        .spinner { 
            width:40px; 
            height:40px; 
            border:4px solid #f3f3f3; 
            border-top:4px solid #667eea; 
            border-radius:50%; 
            animation:spin 1s linear infinite; 
            margin:0 auto; 
        }
        
        @keyframes spin { 
            0%{transform:rotate(0deg)} 
            100%{transform:rotate(360deg)} 
        }
        
        .success-message, .error-message { 
            padding:10px; 
            border-radius:8px; 
            margin-top:15px; 
            text-align:center; 
            display:none; 
        }
        
        .success-message { 
            background:#d4edda; 
            color:#155724; 
        }
        
        .error-message { 
            background:#f8d7da; 
            color:#721c24; 
        }
        
        .result-grid { 
            display:grid; 
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
            gap:20px; 
            margin-top:20px; 
        }
        
        .result-image { 
            text-align:center; 
            padding:10px; 
            background:#f9f9f9; 
            border-radius:8px; 
        }
        
        .result-image img { 
            max-width:100%; 
            border-radius:6px; 
        }
        
        .result-image p { 
            margin-top:6px; 
            font-size:14px; 
            color:#333; 
            font-weight:600; 
        }
        
        .analysis-section { 
            margin-top:20px; 
            padding:15px; 
            background:#f9f9f9; 
            border-radius:8px; 
        }
        
        .analysis-file { 
            margin:8px 0; 
        }
        
        .analysis-file a { 
            color:#667eea; 
            text-decoration:underline; 
        }
        
        .metadata-section { 
            margin-top:15px; 
            padding:15px; 
            background:#f0f0f0; 
            border-radius:8px; 
        }
        
        .metadata-item { 
            margin:6px 0; 
            font-size:14px; 
            color:#333; 
        }
        
        .download-link { 
            display:inline-block; 
            background:#667eea; 
            color:white; 
            padding:6px 12px; 
            border-radius:4px; 
            text-decoration:none; 
            margin:4px 0; 
            font-size:14px; 
        }
        
        .download-link:hover { 
            background:#556bda; 
        }
        
        .plot-container { 
            margin:15px 0; 
            text-align:center; 
        }
        
        .plot-container img { 
            max-width:100%; 
            border-radius:6px; 
            box-shadow:0 3px 10px rgba(0,0,0,0.1); 
        }
        
        /* PharmaMCP specific styles */
        .dissolution-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .dissolution-report {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-top: 10px;
        }
        
        .dissolution-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        /* Style for rendered Markdown */
        .dissolution-report h1, .dissolution-report h2, .dissolution-report h3, .dissolution-report h4 {
            color: #333;
            margin: 15px 0 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .dissolution-report p {
            line-height: 1.5;
            margin: 10px 0;
        }
        
        .dissolution-report table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .dissolution-report th, .dissolution-report td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .dissolution-report th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .dissolution-report tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .dissolution-report code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .dissolution-report pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        /* Advanced parameters section */
        .advanced-parameters {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .advanced-parameters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .advanced-parameters-header h4 {
            color: #333;
            margin: 0;
        }
        
        .advanced-parameters-content {
            margin-top: 10px;
            display: none;
        }
        
        .parameter-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .parameter {
            margin-bottom: 10px;
        }
        
        .parameter label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .parameter input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .parameter-description {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="upload-container">
        <div class="upload-header">
            <h2>Cell Segmentation & Analysis</h2>
            <p>Drag & drop an image or click to browse</p>
        </div>

        <!-- Dashboard Button added here -->
        <button class="dashboard-btn" id="dashboardBtn">Dashboard</button>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <p class="upload-text">Drop your image here or</p>
            <p class="upload-button">Browse</p>
            <input type="file" class="file-input" id="fileInput" accept="image/*">
        </div>

        <div class="image-preview" id="imagePreview">
            <div class="preview-header">
                <span class="preview-title">Selected Image:</span>
                <button class="remove-image" id="removeImage">Remove</button>
            </div>
            <img class="preview-img" id="previewImg" src="" alt="Preview">
        </div>
        
        <!-- Advanced Parameters Section -->
        <div class="advanced-parameters">
            <div class="advanced-parameters-header" id="advancedParamsToggle">
                <h4>Advanced Parameters</h4>
                <span>+</span>
            </div>
            <div class="advanced-parameters-content" id="advancedParamsContent">
                <div class="parameter-group">
                    <div class="parameter">
                        <label for="diameter">Diameter</label>
                        <input type="number" id="diameter" value="15" min="1" step="1">
                        <div class="parameter-description">Expected diameter of cells (pixels)</div>
                    </div>
                    <div class="parameter">
                        <label for="maskThreshold">Mask Threshold</label>
                        <input type="number" id="maskThreshold" value="0.0" min="-6.0" max="6.0" step="0.1">
                        <div class="parameter-description">Threshold for masks (-6.0 to 6.0)</div>
                    </div>
                </div>
                <div class="parameter-group">
                    <div class="parameter">
                        <label for="flowThreshold">Flow Threshold</label>
                        <input type="number" id="flowThreshold" value="0.0" min="0.0" max="10.0" step="0.1">
                        <div class="parameter-description">Threshold for flows (0.0 to 10.0)</div>
                    </div>
                    <div class="parameter">
                        <label for="cellProbabilityThreshold">Cell Probability Threshold</label>
                        <input type="number" id="cellProbabilityThreshold" value="0.0" min="-6.0" max="0.0" step="0.1">
                        <div class="parameter-description">Threshold for cell probability (-6.0 to 0.0)</div>
                    </div>
                </div>
            </div>
        </div>

        <button class="upload-btn" id="uploadBtn">Upload Image</button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <div class="success-message" id="successMessage">Processing completed successfully!</div>
        <div class="error-message" id="errorMessage">Error occurred during processing</div>

        <div id="result-container"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const API_BASE = 'http://localhost:8000';
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImg');
        const uploadBtn = document.getElementById('uploadBtn');
        const dashboardBtn = document.getElementById('dashboardBtn'); // Get the dashboard button
        const advancedParamsToggle = document.getElementById('advancedParamsToggle');
        const advancedParamsContent = document.getElementById('advancedParamsContent');
        const removeImageBtn = document.getElementById('removeImage');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // UI helpers
        function setLoading(on) {
            loading.style.display = on ? 'block' : 'none';
        }
        
        function setError(msg) {
            errorMessage.style.display = 'block';
            errorMessage.textContent = msg || 'Error occurred during processing';
        }
        
        function clearMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
        
        function resetUploadBtn() {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload Image';
        }

        // Dashboard navigation - Open in new tab
        dashboardBtn.addEventListener('click', () => {
            window.open('http://localhost:8090', '_blank');
        });
        
        // Toggle advanced parameters
        advancedParamsToggle.addEventListener('click', () => {
            const isHidden = advancedParamsContent.style.display === 'none' || !advancedParamsContent.style.display;
            advancedParamsContent.style.display = isHidden ? 'block' : 'none';
            advancedParamsToggle.querySelector('span').textContent = isHidden ? '-' : '+';
        });

        // Open file dialog on click
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        ['dragenter','dragover','dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt, e => { 
            e.preventDefault(); 
            e.stopPropagation(); 
        }, false));
        
        ['dragenter','dragover'].forEach(evt => uploadArea.addEventListener(evt, () => uploadArea.classList.add('drag-over')));
        ['dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt, () => uploadArea.classList.remove('drag-over')));
        
        uploadArea.addEventListener('drop', handleDrop);

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                handleFileSelection({ target: fileInput });
            }
        }

        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection(e) {
            const file = e.target.files[0];
            clearMessages();
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function () {
                    previewImage.src = reader.result;
                    previewContainer.style.display = 'block';
                    uploadBtn.classList.add('active');
                    const resultDiv = document.getElementById('result-container');
                    if (resultDiv) resultDiv.innerHTML = '';
                };
                reader.readAsDataURL(file);
            } else {
                setError('Please select an image file.');
            }
        }

        removeImageBtn.addEventListener('click', () => {
            fileInput.value = '';
            previewContainer.style.display = 'none';
            uploadBtn.classList.remove('active');
            clearMessages();
            const resultDiv = document.getElementById('result-container');
            if (resultDiv) resultDiv.innerHTML = '';
        });

        // Upload handler
        uploadBtn.addEventListener('click', async () => {
            if (!uploadBtn.classList.contains('active')) return;
            const file = fileInput.files[0];
            if (!file) return;
            
            setLoading(true);
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Processing...';
            clearMessages();
            const resultDiv = document.getElementById('result-container');
            if (resultDiv) resultDiv.innerHTML = '';

            try {
                const formData = new FormData();
                formData.append('file', file);
                
                // Get advanced parameters
                const diameter = document.getElementById('diameter').value;
                const maskThreshold = document.getElementById('maskThreshold').value;
                const flowThreshold = document.getElementById('flowThreshold').value;
                const cellProbabilityThreshold = document.getElementById('cellProbabilityThreshold').value;
                
                // Add parameters to form data
                formData.append('diameter', diameter);
                formData.append('mask_threshold', maskThreshold);
                formData.append('flow_threshold', flowThreshold);
                formData.append('cell_probability_threshold', cellProbabilityThreshold);

                const res = await fetch(`${API_BASE}/upload-and-segment`, {
                    method: 'POST',
                    body: formData
                });

                let payload;
                const text = await res.text();
                try { 
                    payload = JSON.parse(text); 
                } catch (_) { 
                    payload = { status: 'error', message: text }; 
                }

                if (!res.ok) {
                    const msg = (payload && (payload.detail || payload.message)) || 
                               (typeof payload === 'string' ? payload : 'Upload failed');
                    throw new Error(msg);
                }

                const result = payload;

                setLoading(false);
                resetUploadBtn();

                if (result.status === 'error' || result.error || result.detail) {
                    setError(`Error: ${result.message || result.detail || result.error || 'Processing failed'}`);
                    return;
                }

                successMessage.style.display = 'block';

                // Build result UI
                const rc = document.getElementById('result-container');
                rc.innerHTML = `
                    <h3 style="color:#333;margin-bottom:10px;">Segmentation Results</h3>
                    <div class="result-grid" id="result-grid"></div>
                `;

                const grid = document.getElementById('result-grid');

                // Handle segmentation images
                const imageKeys = ['output','masks_ncolor','outlines','flows','masks_tif'];
                imageKeys.forEach(key => {
                    const imgPath = result.images && result.images[key];
                    if (!imgPath) return;
                    
                    const src = (typeof imgPath === 'string' && 
                                (imgPath.startsWith('http://') || imgPath.startsWith('https://'))) ?
                                imgPath : (API_BASE + (imgPath.startsWith('/') ? '' : '/') + imgPath);

                    const ext = src.split('.').pop().toLowerCase();
                    const label = key.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase()).replace('Tif','TIFF');

                    const div = document.createElement('div');
                    div.className = 'result-image';

                    if (['png','jpg','jpeg','webp','gif'].includes(ext)) {
                        div.innerHTML = `
                            <p>${label}</p>
                            <img src="${src}" alt="${key}" />
                            <p style="font-size:12px;color:#666;margin-top:6px;">
                                <a href="${src}" target="_blank" rel="noopener">Open Full Size</a>
                            </p>
                        `;
                    } else if (['tif','tiff'].includes(ext)) {
                        div.innerHTML = `
                            <p>${label} (TIFF)</p>
                            <object data="${src}" type="image/tiff" style="width:100%; min-height:200px; display:block;">
                                <p style="font-size:14px;color:#666;">Preview not available. <a href="${src}" download>Download TIFF</a></p>
                            </object>
                            <p style="font-size:12px;color:#666;margin-top:6px;"><a href="${src}" download>Download TIFF</a></p>
                        `;
                    } else {
                        div.innerHTML = `
                            <p>${label}</p>
                            <p style="font-size:14px;color:#666;"><a href="${src}" target="_blank" rel="noopener">Open file</a></p>
                        `;
                    }
                    grid.appendChild(div);
                });

                // Add analysis results section
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'analysis-section';
                analysisDiv.innerHTML = `
                    <h4 style="color:#333;margin:10px 0;">Particle Analysis Results</h4>
                `;

                // Add distribution plot if available
                const plotPath = result.analysis_results?.plots;
                if (plotPath) {
                    const plotSrc = (typeof plotPath === 'string' && 
                                   (plotPath.startsWith('http://') || plotPath.startsWith('https://'))) ?
                                   plotPath : (API_BASE + (plotPath.startsWith('/') ? '' : '/') + plotPath);
                    
                    analysisDiv.innerHTML += `
                        <div class="plot-container">
                            <p style="margin-bottom:10px;font-weight:600;color:#333;">Particle Distribution Analysis</p>
                            <img src="${plotSrc}" alt="Distribution Plot" />
                        </div>
                    `;
                }

                // Add metadata from JSON
                const jsonPath = result.analysis_results?.json;
                if (jsonPath) {
                    const jsonSrc = (typeof jsonPath === 'string' && 
                                   (jsonPath.startsWith('http://') || jsonPath.startsWith('https://'))) ?
                                   jsonPath : (API_BASE + (jsonPath.startsWith('/') ? '' : '/') + jsonPath);
                    
                    // Fetch JSON data for display
                    try {
                        const jsonRes = await fetch(jsonSrc);
                        if (jsonRes.ok) {
                            const jsonData = await jsonRes.json();
                            
                            analysisDiv.innerHTML += `
                                <div class="metadata-section">
                                    <p style="color:#333;font-weight:600;margin-bottom:10px;">Analysis Summary</p>
                                    <div class="metadata-item"><strong>D10:</strong> ${jsonData.d10.toFixed(2)} ¬µm</div>
                                    <div class="metadata-item"><strong>D50:</strong> ${jsonData.d50.toFixed(2)} ¬µm</div>
                                    <div class="metadata-item"><strong>D90:</strong> ${jsonData.d90.toFixed(2)} ¬µm</div>
                                    <div class="metadata-item"><strong>D99:</strong> ${jsonData.d99.toFixed(2)} ¬µm</div>
                                    <div class="metadata-item"><strong>Particle Count:</strong> ${jsonData.particle_count}</div>
                                    <div class="metadata-item"><strong>Scale Factor:</strong> ${jsonData.scale_factor}</div>
                                </div>
                            `;
                        }
                    } catch (e) {
                        console.warn('Could not load JSON data:', e);
                    }
                }

                // Add download links for analysis files
                const excelPath = result.analysis_results?.excel;
                if (jsonPath || excelPath) {
                    analysisDiv.innerHTML += `<div style="margin-top:15px;padding-top:10px;border-top:1px solid #eee;">`;
                    
                    if (jsonPath) {
                        const jsonSrc = (typeof jsonPath === 'string' && 
                                       (jsonPath.startsWith('http://') || jsonPath.startsWith('https://'))) ?
                                       jsonPath : (API_BASE + (jsonPath.startsWith('/') ? '' : '/') + jsonPath);
                        
                        analysisDiv.innerHTML += `
                            <a href="${jsonSrc}" download class="download-link">Download JSON Data</a>
                        `;
                    }
                    
                    if (excelPath) {
                        const excelSrc = (typeof excelPath === 'string' && 
                                        (excelPath.startsWith('http://') || excelPath.startsWith('https://'))) ?
                                        excelPath : (API_BASE + (excelPath.startsWith('/') ? '' : '/') + excelPath);
                        
                        analysisDiv.innerHTML += `
                            <a href="${excelSrc}" download class="download-link">Download Excel Report</a>
                        `;
                    }
                    
                    analysisDiv.innerHTML += '</div>';
                }

                // Add basic metadata
                const metaDiv = document.createElement('div');
                metaDiv.style.marginTop = '12px';
                metaDiv.innerHTML = `
                    <p style="color:#666;">
                        ID: ${result.id || 'N/A'} &nbsp;&nbsp; 
                        Cells Detected: ${result.mask_count ?? (result.max_mask_value ?? 'N/A')}
                    </p>
                `;

                rc.appendChild(analysisDiv);
                rc.appendChild(metaDiv);
                
                // Add dissolution prediction to the UI if available
                if (result.dissolution_prediction) {
                    const predictionDiv = document.createElement('div');
                    predictionDiv.className = 'dissolution-section';
                    
                    const prediction = result.dissolution_prediction;
                    const qc = prediction.qc_metrics;
                    
                    // Add T50 and T90 to the metadata section
                    const metadataSection = analysisDiv.querySelector('.metadata-section');
                    if (metadataSection) {
                        metadataSection.innerHTML += `
                            <div class="metadata-item"><strong>T50:</strong> ${qc.T50 ? qc.T50.toFixed(2) + ' min' : 'N/A'}</div>
                            <div class="metadata-item"><strong>T90:</strong> ${qc.T90 ? qc.T90.toFixed(2) + ' min' : 'N/A'}</div>
                        `;
                    }
                    
                    // Add dissolution metrics cards
                    predictionDiv.innerHTML = `
                        <h4 style="color:#333;margin:10px 0;">Dissolution Prediction</h4>
                        <p style="color:#666;margin-bottom:15px;">Predicted using particle size D50: ${prediction.d50.toFixed(2)} Œºm</p>
                        
                        <div class="dissolution-metrics">
                            <div class="metric-card">
                                <div class="metric-label">F2 Similarity</div>
                                <div class="metric-value">${qc.f2 ? qc.f2.toFixed(1) : 'N/A'}</div>
                                <div style="font-size:12px;color:#666;">(higher = better match)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">T50</div>
                                <div class="metric-value">${qc.T50 ? qc.T50.toFixed(2) + ' min' : 'N/A'}</div>
                                <div style="font-size:12px;color:#666;">Time for 50% dissolution</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">T90</div>
                                <div class="metric-value">${qc.T90 ? qc.T90.toFixed(2) + ' min' : 'N/A'}</div>
                                <div style="font-size:12px;color:#666;">Time for 90% dissolution</div>
                            </div>
                        </div>
                        
                        <div class="dissolution-report">
                            <div class="report-content" style="min-height:300px; padding: 10px;">
                                <p style="color:#666;text-align:center;">Loading dissolution report...</p>
                            </div>
                        </div>
                    `;
                    
                    // Fetch and render the Markdown report
                    const reportSrc = (typeof prediction.report === 'string' && 
                                      (prediction.report.startsWith('http://') || prediction.report.startsWith('https://'))) ?
                                      prediction.report : (API_BASE + prediction.report);
                    
                    fetch(reportSrc)
                        .then(res => {
                            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                            return res.text();
                        })
                        .then(mdText => {
                            const html = marked.parse(mdText);
                            const reportContent = predictionDiv.querySelector('.report-content');
                            reportContent.innerHTML = html;
                            
                            // Add some additional styling to the rendered Markdown
                            const tables = reportContent.querySelectorAll('table');
                            tables.forEach(table => {
                                table.style.width = '100%';
                                table.style.borderCollapse = 'collapse';
                                table.style.margin = '15px 0';
                                
                                const ths = table.querySelectorAll('th');
                                ths.forEach(th => {
                                    th.style.backgroundColor = '#f2f2f2';
                                    th.style.fontWeight = 'bold';
                                    th.style.padding = '8px';
                                    th.style.border = '1px solid #ddd';
                                });
                                
                                const tds = table.querySelectorAll('td');
                                tds.forEach(td => {
                                    td.style.padding = '8px';
                                    td.style.border = '1px solid #ddd';
                                });
                            });
                        })
                        .catch(err => {
                            console.error('Error loading report:', err);
                            const reportContent = predictionDiv.querySelector('.report-content');
                            reportContent.innerHTML = 
                                `<p style="color:#721c24;text-align:center;">Error loading report: ${err.message}</p>`;
                        });
                    
                    // Add download links
                    const downloadLinks = `
                        <div style="margin-top:15px;padding-top:10px;border-top:1px solid #eee;">
                            <a href="${reportSrc}" download class="download-link">Download Dissolution Report</a>
                            <a href="${API_BASE}${prediction.profile}" download class="download-link" style="margin-left:10px;">Download Profile Data</a>
                        </div>
                    `;
                    predictionDiv.innerHTML += downloadLinks;
                    
                    // Add to the result container
                    rc.appendChild(predictionDiv);
                }

            } catch (err) {
                console.error('Upload error:', err);
                setLoading(false);
                resetUploadBtn();
                setError(err.message || 'Failed to process image.');
            }
        });
    });
    </script>
</body>
</html>